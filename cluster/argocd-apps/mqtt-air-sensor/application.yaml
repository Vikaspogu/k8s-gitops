---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mqtt-air-sensor
  namespace: argocd
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: home
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  source:
    chart: app-template
    repoURL: https://bjw-s.github.io/helm-charts/
    targetRevision: "0.1.1"
    helm:
      releaseName: mqtt-air-sensor
      valueFiles:
        - "values.yaml"
      values: |
        replicas: 1
        image:
          repository: vikaspogu/mqtt-air-sensor
          pullPolicy: IfNotPresent
          tag: "1.0.0"

        strategy:
          type: Recreate

        env:
          NODE_NAME:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
          ENVIRONMENT: prod
          MQTT_BROKER: mosquitto.home.svc.cluster.local
          TOPIC: "sds011-mqtt/air-quality/$(NODE_NAME)"

        securityContext:
          privileged: true

        probes:
          liveness:
            enabled: false
          readiness:
            enabled: false
          startup:
            enabled: false

        resources:
          limits:
            cpu: 520m
            memory: 520Mi
          requests:
            cpu: 250m
            memory: 250Mi

        tolerations:
          - key: "k3s-arm"
            operator: "Exists"
        service:
          main:
            ports:
              http:
                port: 8080
        persistence:
          dev-ttyusb:
            enabled: true
            type: hostPath
            hostPath: /dev/ttyUSB0

        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - {
                        key: "feature.node.kubernetes.io/custom-air-sensor",
                        operator: In,
                        values: ["true"],
                      }

apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://argoproj.github.io/argo-helm
      chart: argo-cd
      version: 5.28.2
      sourceRef:
        kind: HelmRepository
        name: argocd-charts
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    server:
      extraArgs:
        - --insecure
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: "nginx"
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          hajimari.io/enable: "true"
          hajimari.io/icon: cloud-outline
          hajimari.io/appName: "ArgoCD"
        hosts:
          - argocd.${SECRET_DOMAIN}
        paths:
          - /
        tls:
          - hosts:
              - argocd.${SECRET_DOMAIN}
            secretName: "argocd-tls"
      config:
        kustomize.buildOptions: "--enable-alpha-plugins --enable-helm"
        url: https://argocd.${SECRET_DOMAIN}
        application.instanceLabelKey: argocd.argoproj.io/instance
        accounts.admin: apiKey
        repositories: |
          - url: ${GITHUB_REPO}
      rbacConfig:
        policy.csv: |
          g, /ArgoCDAdmins, role:admin
    dex:
      enabled: false
    configs:
      secret:
        createSecret: true
        argocdServerAdminPassword: $2a$10$RmkozzGo6eBRwkpv1TfPruLq6BYVdcWSZWoMK3oIvM2niHLUd4Gs2

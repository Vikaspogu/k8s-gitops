---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: argocd-application-set
  namespace: argocd
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  dependsOn:
    - name: argocd
      namespace: argocd
  values:
    resources:
      apiVersion: argoproj.io/v1alpha1
      kind: ApplicationSet
      metadata:
        name: argocd-apps-application-set
        namespace: argocd
        finalizers:
          - resources-finalizer.argocd.argoproj.io
      spec:
        generators:
          - git:
              repoURL: https://github.com/Vikaspogu/k8s-gitops.git
              revision: main
              directories:
                - path: cluster/argocd-apps/*
        template:
          metadata:
            name: '{{path.basename}}'
          spec:
            destination:
              namespace: home
              server: "https://kubernetes.default.svc"
            project: default
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
            source:
              path: "{{path}}"
              repoURL: "https://github.com/Vikaspogu/k8s-gitops"
              targetRevision: "main"

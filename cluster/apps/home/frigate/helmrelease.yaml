---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: frigate
  namespace: home
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://blakeblackshear.github.io/blakeshome-charts/
      chart: frigate
      version: 7.0.0
      sourceRef:
        kind: HelmRepository
        name: blakeshome-charts
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  dependsOn:
    - name: rook-ceph-cluster
      namespace: rook-ceph
  values:
    image:
      repository: docker.io/blakeblackshear/frigate
      tag: 0.11.1
    podAnnotations:
      configmap.reloader.stakater.com/reload: "frigate"
    env:
      TZ: ${TIMEZONE}
    coral:
      enabled: true
    config: |
      mqtt:
        host: mosquitto.home.svc.cluster.local
        topic_prefix: frigate
      detectors:
        coral:
          type: edgetpu
          device: usb
      database:
        path: /data/frigate.db
      objects:
        track:
          - person
          - dog
      cameras:
        doorbell:
          ffmpeg:
            inputs:
              - path: rtsp://${SECRET_FRIGATE_RSTP_USERNAME}:${SECRET_FRIGATE_RTSP_PASSWORD}@${SECRET_FRONTDOOR_CAMERA}/live0
                roles:
                  - detect
                  - record
                  - rtmp
          objects:
            filters:
              person:
                min_area: 1500
                max_area: 100000
                threshold: 0.75
                min_score: 0.60
          record:
            enabled: true
            retain_days: 4
            events:
              retain:
                default: 10
              objects:
                - person
                - dog
          mqtt:
            enabled: True
            timestamp: True
            bounding_box: True
            crop: False
    persistence:
      data:
        enabled: true
    probes:
      startup:
        enabled: true
    extraVolumes:
      - name: media
        persistentVolumeClaim:
          claimName: frigate-config
    extraVolumeMounts:
      - mountPath: /media
        name: media
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: "nginx"
        hajimari.io/enable: "true"
        hajimari.io/appName: "Frigate"
        cert-manager.io/cluster-issuer: "letsencrypt-production"
      hosts:
        - host: "frigate.${SECRET_DOMAIN}"
          paths:
            - "/"
      tls:
        - hosts:
            - "frigate.${SECRET_DOMAIN}"
    resources:
      limits:
        memory: 2500Mi
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - { key: "feature.node.kubernetes.io/custom-coral-tpu", operator: In, values: ["true"] }
